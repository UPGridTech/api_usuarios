---
- name: Configurar CockroachDB sem TLS + registro no HAProxy
  hosts: all
  gather_facts: yes

  vars:
    register_api_url: "http://haproxy.upgrid.local:5000/register/db"
    cluster_name: "upgrid-db"
    data_dir: "/var/lib/cockroach/data"
    cockroach_bin: "/usr/local/bin/cockroach"
    cluster_join_addr: "haproxy.upgrid.local:26257"

  tasks:

    - name: Atualizar pacotes
      apt:
        update_cache: yes
        upgrade: dist

    - name: Instalar dependências
      apt:
        name:
          - wget
          - tar
        state: present

    - name: Criar diretório de dados
      file:
        path: "{{ data_dir }}"
        state: directory
        owner: root
        group: root
        mode: "0755"

    # ==========================
    # DOWNLOAD BINÁRIO COCKROACH
    # ==========================

    - name: Verificar se o binário já foi baixado
      stat:
        path: /tmp/cockroach.tgz
      register: cockroach_tgz

    - name: Baixar CockroachDB
      get_url:
        url: https://binaries.cockroachdb.com/cockroach-v24.1.3.linux-amd64.tgz
        dest: /tmp/cockroach.tgz
        mode: "0644"
      when: not cockroach_tgz.stat.exists

    - name: Extrair CockroachDB
      unarchive:
        src: /tmp/cockroach.tgz
        dest: /tmp/
        remote_src: yes
      when: not cockroach_tgz.stat.exists

    - name: Copiar binário do CockroachDB
      copy:
        src: "/tmp/cockroach-v24.1.3.linux-amd64/cockroach"
        dest: "{{ cockroach_bin }}"
        mode: '0755'
      args:
        force: yes

    # ==========================
    # SYSTEMD SERVICE
    # ==========================

    - name: Criar service do CockroachDB
      copy:
        dest: /etc/systemd/system/cockroach.service
        content: |
          [Unit]
          Description=CockroachDB node (NO TLS)
          After=network-online.target
          Wants=network-online.target

          [Service]
          Type=notify
          ExecStart={{ cockroach_bin }} start \
            --insecure \
            --store={{ data_dir }} \
            --advertise-addr={{ ansible_default_ipv4.address }} \
            --listen-addr=0.0.0.0:26257 \
            --http-addr=0.0.0.0:8080 \
            --join={{ cluster_join_addr }} \
            --cache=1GB \
            --max-sql-memory=1GB

          Restart=always
          RestartSec=10

          [Install]
          WantedBy=multi-user.target

    - name: Reload systemd
      command: systemctl daemon-reload

    - name: Iniciar CockroachDB
      service:
        name: cockroach
        state: restarted
        enabled: yes

    # ==========================
    # HEALTHCHECK
    # ==========================

    - name: Verificar se o nó está online
      uri:
        url: "http://localhost:8080/health"
        status_code: 200
      register: health
      retries: 20
      delay: 5
      until: health.status == 200

    # ==========================
    # REGISTRO NO HAProxy via API
    # ==========================

    - name: Registrar nó no HAProxy
      uri:
        url: "{{ register_api_url }}"
        method: POST
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          node: "{{ ansible_hostname }}"
          ip: "{{ ansible_default_ipv4.address }}"
          ports:
            - 26257
            - 8080
        status_code: 200,201,202,204
      register: register_response
      retries: 5
      delay: 3
      until: register_response.status in [200,201,202,204]

    - name: Resultado do registro
      debug:
        msg:
          - "Status API: {{ register_response.status }}"
          - "{{ register_response.content }}"
