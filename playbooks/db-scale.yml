---
- name: Configurar Cliente Local e Provisionar Cluster CockroachDB
  hosts: all
  gather_facts: yes
  become: yes 

  vars:
    
    register_api_url: "http://haproxy.upgrid.local:5000/register"
    
    # Variáveis para o cluster CockroachDB (Nós Iniciais)
    cockroach_nodes: 3 
    cockroach_base_sql_port: 26257 
    cockroach_base_http_port: 8080 
    cockroach_internal_port: 26357 
    cockroach_join_addr: "roach1:{{ cockroach_internal_port }},roach2:{{ cockroach_internal_port }},roach3:{{ cockroach_internal_port }}"
    cockroach_image: "cockroachdb/cockroach:latest"

  tasks:

    # --- 1. INSTALAÇÃO DOCKER (SUAS TASKS ORIGINAIS) ---

    - name: Garantir que o cache de pacotes esteja atualizado e fazer o upgrade
      ansible.builtin.apt:
        update_cache: yes
        upgrade: dist

    - name: Instalar Git e pré-requisitos do Docker
      ansible.builtin.apt:
        name:
          - git
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present

    - name: Adicionar chave GPG do Docker
      ansible.builtin.get_url:
        url: https://download.docker.com/linux/debian/gpg
        dest: /usr/share/keyrings/docker-archive-keyring.gpg
        mode: '0644'

    - name: Adicionar repositório Docker
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian {{ ansible_distribution_release }} stable"
        state: present
        filename: docker

    - name: Instalar Docker e Plugins
      ansible.builtin.apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-compose-plugin
        state: present
        update_cache: yes

    - name: Garantir que Docker esteja ativo
      ansible.builtin.service:
        name: docker
        state: started
        enabled: yes

    # --- 2. REGISTRO NA API (SUAS TASKS ORIGINAIS) ---

    - name: Registrar cliente na API
      ansible.builtin.uri:
        url: "{{ register_api_url }}"
        method: POST
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          name: "{{ ansible_hostname }}"
          ip: "{{ ansible_default_ipv4.address }}" # Usando a variável correta para IP
          port: 80
          backend: "bk_web_apps"
        status_code: 200,201,202,204
        return_content: yes
      register: register_response
      retries: 4
      delay: 5
      until: register_response.status is defined and register_response.status in [200,201,202,204]

    - name: Mostrar resultado do registro
      ansible.builtin.debug:
        msg:
          - "Status HTTP: {{ register_response.status | default('no-status') }}"
          - "Conteúdo: {{ register_response.content | default('no-content') }}"

    - name: Falhar se registro não ocorreu
      ansible.builtin.fail:
        msg: "Registro falhou: HTTP={{ register_response.status | default('no-status')}}"
      when: register_response.status not in [200,201,202,204]

    # --- 3. PROVISIONAMENTO INICIAL COCKROACHDB (3 NÓS) ---

    - name: Criar network bridge 'roachnet'
      community.docker.docker_network:
        name: roachnet
        driver: bridge
        state: present
    
    - name: Criar volumes para os nós iniciais CockroachDB
      community.docker.docker_volume:
        name: "roach{{ item }}"
        state: present
      loop: "{{ range(1, cockroach_nodes + 1) | list }}"
    
    - name: Rodar containers CockroachDB iniciais
      community.docker.docker_container:
        name: "roach{{ item }}"
        hostname: "roach{{ item }}"
        image: "{{ cockroach_image }}"
        state: started
        restart_policy: always
        network_mode: roachnet
        ports:
          # Mapeamento dinâmico de portas SQL e HTTP no HOST
          - "{{ cockroach_base_sql_port + item - 1 }}:{{ cockroach_base_sql_port + item - 1 }}"
          - "{{ cockroach_base_http_port + item - 1 }}:{{ cockroach_base_http_port + item - 1 }}"
        volumes:
          - "roach{{ item }}:/cockroach/cockroach-data"
        command: >
          start 
          --advertise-addr=roach{{ item }}:{{ cockroach_internal_port }}
          --http-addr=roach{{ item }}:{{ cockroach_base_http_port + item - 1 }}
          --listen-addr=roach{{ item }}:{{ cockroach_internal_port }}
          --sql-addr=roach{{ item }}:{{ cockroach_base_sql_port + item - 1 }}
          --insecure
          --join={{ cockroach_join_addr }}
      loop: "{{ range(1, cockroach_nodes + 1) | list }}"
      register: initial_deployment

    - name: Inicializar Cluster CockroachDB (apenas se a implantação inicial foi bem-sucedida)
      ansible.builtin.shell: |
        docker exec -i roach1 ./cockroach init --host=roach1:{{ cockroach_internal_port }} --insecure
      register: init_result
      changed_when: "'initialized cluster' in init_result.stdout"
      # Usa um marcador de arquivo para garantir que rode apenas uma vez (melhor prática de idempotência)
      args:
        creates: /etc/cockroachdb_initialized 

    - name: Criar arquivo marcador de inicialização
      ansible.builtin.file:
        path: /etc/cockroachdb_initialized
        state: touch
      when: init_result.changed

    # --- 4. AUTOSCALING (ADIÇÃO DE NOVO NÓ) ---

    # Esta task será executada SOMENTE se você passar a variável 'new_node_index' 
    # e se ela for maior que o número de nós iniciais (3).
    - name: Adicionar Novo Nó CockroachDB (Autoscaling)
      when: new_node_index is defined and new_node_index | int > cockroach_nodes
      block:
        - name: Definir variáveis do novo nó
          ansible.builtin.set_fact:
            new_sql_port: "{{ cockroach_base_sql_port + new_node_index | int - 1 }}"
            new_http_port: "{{ cockroach_base_http_port + new_node_index | int - 1 }}"
            new_node_name: "roach{{ new_node_index }}"

        - name: Criar volume para o novo nó '{{ new_node_name }}'
          community.docker.docker_volume:
            name: "{{ new_node_name }}"
            state: present

        - name: Rodar container CockroachDB para o novo nó
          community.docker.docker_container:
            name: "{{ new_node_name }}"
            hostname: "{{ new_node_name }}"
            image: "{{ cockroach_image }}"
            state: started
            restart_policy: always
            network_mode: roachnet
            ports:
              # As portas são calculadas dinamicamente
              - "{{ new_sql_port }}:{{ new_sql_port }}" 
              - "{{ new_http_port }}:{{ new_http_port }}" 
            volumes:
              - "{{ new_node_name }}:/cockroach/cockroach-data"
            command: >
              start 
              --advertise-addr={{ new_node_name }}:{{ cockroach_internal_port }}
              --http-addr={{ new_http_port }}
              --listen-addr={{ new_node_name }}:{{ cockroach_internal_port }}
              --sql-addr={{ new_sql_port }}
              --insecure
              --join={{ cockroach_join_addr }}
          
        - name: Mostrar que o novo nó foi adicionado
          ansible.builtin.debug:
            msg: "Nó {{ new_node_name }} adicionado com portas SQL: {{ new_sql_port }} e HTTP: {{ new_http_port }}"