name: Build e Teste na PR para Dev

on:
  pull_request:
    branches:
      - dev
    types: [opened, synchronize, reopened]

jobs:
  build-and-run:
    runs-on: self-hosted
    steps:
      - name: Checkout cÃ³digo da PR
        uses: actions/checkout@v4
      - name: Deploy VM Terraform
        working-directory: terraform
        run: |
          terraform init
      - name: apply terraform
        run: |
          terraform apply -v "vm_count=1" --auto-aprove
      - name: Obter todos os IPs das VMs
        id: vm_ips
        working-directory: terraform
        run: |
          VM_IPS=$(terraform output -json vm_ips | jq -r '.[]')
          echo "VM_IPS=$VM_IPS" >> $GITHUB_ENV
          echo "IPs das VMs: $VM_IPS"

      - name: Rodar Ansible em cada VM
        run: |
          for IP in $VM_IPS; do
            echo "============================"
            echo "Rodando Ansible em $IP"
            ansible-playbook playbooks/setup_vm.yml \
              -i "${IP}," \
              -u "admin" \
              --extra-vars "pr_branch=${{ github.head_ref }}"
            echo "============================"
          done

      - name: Healthcheck
        run: |
          curl -f http://$VM_IP/healthz
        
