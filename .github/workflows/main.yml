name: Build e Teste na PR para Dev

on:
  pull_request:
    branches:
      - dev
    types: [opened, synchronize, reopened, closed]

jobs:
  build-and-run:
    runs-on: self-hosted
    steps:
      - name: Checkout cÃ³digo da PR
        uses: actions/checkout@v4

      - name: Set PR Workspace Name
        run: echo "PR_WORKSPACE=pr-${{ github.event.pull_request.number }}" >> $GITHUB_ENV

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_TOKEN_KEY }}
          aws-region: us-east-1

      - name: Terraform Init + Select Workspace
        working-directory: terraform
        run: |
          terraform init -reconfigure -input=false \
            -backend-config="bucket=s3-bkt-s3nai" \
            -backend-config="key=pr-${{ github.event.pull_request.number }}/terraform.tfstate" \
            -backend-config="region=us-east-1" \
            -backend-config="dynamodb_table=s3-bkt-s3nai-lock" \
            -backend-config="encrypt=true"
      - name: Terraform Apply (on PR open/sync)
        if: github.event.action != 'closed'
        working-directory: terraform
        run: |
          terraform apply -var "vm_count=1" -auto-approve
          terraform state pull > /home/felipe/state/${PR_WS}.tfstate

      - name: Terraform Destroy (on PR closed)
        if: github.event.action == 'closed'
        working-directory: terraform
        run: |
          terraform destroy -var "vm_count=1" -auto-approve
          
      - name: Obter todos os IPs das VMs
        id: vm_ips
        working-directory: terraform
        run: |
          VM_IPS=$(terraform output -json vm_ip | jq -r '.[]')
          echo "VM_IPS=$VM_IPS" >> $GITHUB_ENV
          echo "IPs das VMs: $VM_IPS"

      - name: Run Ansible on each VM
        run: |
          for IP in $VM_IPS; do
            echo "=== Running Ansible on $IP ==="
            ansible-playbook playbooks/dev-playbook.yml \
              -i "${IP}," \
              -u "${{ secrets.ANSIBLE_USER }}" \
              --extra-vars "ansible_password=${{ secrets.ANSIBLE_PASSWORD }} pr_branch=${{ github.event.pull_request.head.ref }} pr_number=${{ github.event.pull_request.number }} github_token=${{ secrets.GITHUB_PAT }} postgres_user=${{ secrets.POSTGRES_USER }} postgres_password=${{ secrets.POSTGRES_PASSWORD }} postgres_db=${{ secrets.POSTGRES_DB }} signoz_key=PF0rQtvZdo00lgWLndHcKih-g3eNNS1-Uz5k app_path=/home/felipe/src/" \
              --ssh-common-args='-o StrictHostKeyChecking=no' \
              -vvv
          done

      - name: Healthcheck
        run: |
          curl -f http://$VM_IP:5000
        
