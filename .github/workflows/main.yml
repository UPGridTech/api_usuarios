name: Build e Teste na PR para Dev

on:
  pull_request:
    branches:
      - dev
    types: [opened, synchronize, reopened, closed]

jobs:
  build-and-run:
    runs-on: self-hosted
    steps:
      - name: Checkout cÃ³digo da PR
        uses: actions/checkout@v4

      - name: Set PR Workspace Name
        run: echo "PR_WORKSPACE=pr-${{ github.event.pull_request.number }}" >> $GITHUB_ENV

      - name: Setup Workspace Terraform Cloud
        run: |
          echo "Using workspace: $PR_WORKSPACE"
          curl \
            --header "Authorization: Bearer ${{ secrets.TF_API_TOKEN }}" \
            --header "Content-Type: application/vnd.api+json" \
            --request POST \
            --data "{\"data\":{\"attributes\":{\"name\":\"${PR_WORKSPACE}\"},\"type\":\"workspaces\"}}" \
            https://app.terraform.io/api/v2/organizations/upgrid/workspaces || true
      
      - name: Terraform Init
        working-directory: terraform
        run: |
          terraform init -reconfigure \
            -backend-config="organization=upgrid" \
            -backend-config="workspaces.name=${PR_WS}" \
            -input=false

      - name: Terraform Apply (on PR open/sync)
        if: github.event.action != 'closed'
        working-directory: terraform
        run: terraform apply -var "vm_count=1" -auto-approve

      - name: Terraform Destroy (on PR closed)
        if: github.event.action == 'closed'
        working-directory: terraform
        run: |
          echo "PR_WORKSPACE=pr-${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          terraform init -input=false \
            -backend-config="organization=upgrid" \
            -backend-config="workspaces.name=${PR_WORKSPACE}"
          terraform destroy -var "vm_count=1" -auto-approve
          # opcional: apagar workspace via API
          PR_WS="pr-${GITHUB_EVENT_NUMBER}"
          curl --header "Authorization: Bearer ${{ secrets.TF_API_TOKEN }}" \
               --header "Content-Type: application/vnd.api+json" \
               --request DELETE \
               https://app.terraform.io/api/v2/organizations/upgrid/workspaces/${PR_WS}
      - name: Obter todos os IPs das VMs
        id: vm_ips
        working-directory: terraform
        run: |
          VM_IPS=$(terraform output -json vm_ip | jq -r '.[]')
          echo "VM_IPS=$VM_IPS" >> $GITHUB_ENV
          echo "IPs das VMs: $VM_IPS"

      - name: Run Ansible on each VM
        run: |
          for IP in $VM_IPS; do
            echo "=== Running Ansible on $IP ==="
            ansible-playbook playbooks/vm_setup.yml \
              -i "${IP}," \
              -u "${{ secrets.ANSIBLE_USER }}" \
              --extra-vars "ansible_password=${{ secrets.ANSIBLE_PASSWORD }} pr_branch=${{ github.event.pull_request.number }}" \
              --ssh-common-args='-o StrictHostKeyChecking=no' \
              -vvv
          done

      - name: Healthcheck
        run: |
          curl -f http://$VM_IP/healthz
        
