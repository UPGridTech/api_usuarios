name: Build e Teste na PR para Dev

on:
  pull_request:
    branches:
      - dev
    types: [opened, synchronize, reopened]

jobs:
  build-and-run:
    runs-on: self-hosted
    steps:
      - name: Checkout cÃ³digo da PR
        uses: actions/checkout@v4
      - name: Deploy VM Terraform
        run: |
          terraform init
          terrafom apply -v "vm_count=1" --auto-aprove
      - name: Get VM IP
        id: vm
        run: |
          VM_IP=$(terraform output -raw vm_ip)
          echo "VM_IP=$VM_IP" >> $GITHUB_ENV
      - name: Run Ansible Playbook
        run: |
          ansible-playbook playbooks/setup_vm.yml \
            -i "$VM_IP," \
            --extra-vars "ansible_user=adminsenai@134" \
            --extra-vars "pr_branch=${{ github.head_ref }}"
      - name: Healthcheck
        run: |
          curl -f http://$VM_IP/healthz
        
